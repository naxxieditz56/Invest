<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - Cadbury Dairy Milk</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="js/firebase-config.js"></script>
</head>
<body>
  <div class="mobile-container">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="logo">
        <i class="fas fa-user"></i> Profile
      </div>
      <div class="top-icons">
        <i class="fas fa-edit" onclick="editProfile()"></i>
        <i class="fas fa-cog"></i>
      </div>
    </div>

    <!-- Profile Header -->
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="position: relative; display: inline-block;">
        <img id="profileImage" src="https://via.placeholder.com/100" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; object-fit: cover;">
        <div onclick="changeProfileImage()" style="position: absolute; bottom: 0; right: 0; background: linear-gradient(45deg, #4facfe, #00f2fe); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
          <i class="fas fa-camera" style="color: white; font-size: 14px;"></i>
        </div>
      </div>
      <h2 style="color: white; margin: 10px 0 5px;" id="profileName">Loading...</h2>
      <p style="color: rgba(255,255,255,0.6);" id="profileEmail">loading@email.com</p>
    </div>

    <!-- Stats Cards -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
      <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 15px; text-align: center;">
        <i class="fas fa-wallet" style="color: #4facfe; font-size: 24px; margin-bottom: 5px;"></i>
        <div style="color: white; font-size: 18px; font-weight: bold;" id="walletBalance">₹0</div>
        <div style="color: rgba(255,255,255,0.6); font-size: 11px;">Wallet</div>
      </div>
      <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 15px; text-align: center;">
        <i class="fas fa-chart-line" style="color: #4caf50; font-size: 24px; margin-bottom: 5px;"></i>
        <div style="color: white; font-size: 18px; font-weight: bold;" id="totalInvestment">₹0</div>
        <div style="color: rgba(255,255,255,0.6); font-size: 11px;">Invested</div>
      </div>
      <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 15px; text-align: center;">
        <i class="fas fa-hand-holding-usd" style="color: #ffd700; font-size: 24px; margin-bottom: 5px;"></i>
        <div style="color: white; font-size: 18px; font-weight: bold;" id="totalEarnings">₹0</div>
        <div style="color: rgba(255,255,255,0.6); font-size: 11px;">Earnings</div>
      </div>
    </div>

    <!-- Profile Menu -->
    <div style="background: rgba(255,255,255,0.1); border-radius: 20px; padding: 15px; margin-bottom: 20px;">
      <div class="menu-item" onclick="location.href='transactions.html'" style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <i class="fas fa-history" style="width: 30px; color: #4facfe;"></i>
        <span style="color: white; flex: 1;">Transaction History</span>
        <i class="fas fa-chevron-right" style="color: rgba(255,255,255,0.5);"></i>
      </div>
      
      <div class="menu-item" onclick="location.href='referral.html'" style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <i class="fas fa-users" style="width: 30px; color: #ff6b6b;"></i>
        <span style="color: white; flex: 1;">Referral Program</span>
        <span style="background: linear-gradient(45deg, #ff6b6b, #feca57); padding: 3px 8px; border-radius: 10px; color: white; font-size: 11px;">New</span>
      </div>
      
      <div class="menu-item" onclick="location.href='bank-details.html'" style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <i class="fas fa-university" style="width: 30px; color: #00f2fe;"></i>
        <span style="color: white; flex: 1;">Bank Details</span>
        <i class="fas fa-chevron-right" style="color: rgba(255,255,255,0.5);"></i>
      </div>
      
      <div class="menu-item" onclick="location.href='security.html'" style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <i class="fas fa-shield-alt" style="width: 30px; color: #a8e063;"></i>
        <span style="color: white; flex: 1;">Security Settings</span>
        <i class="fas fa-chevron-right" style="color: rgba(255,255,255,0.5);"></i>
      </div>
      
      <div class="menu-item" onclick="location.href='support.html'" style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <i class="fas fa-headset" style="width: 30px; color: #ffd700;"></i>
        <span style="color: white; flex: 1;">Support & Help</span>
        <i class="fas fa-chevron-right" style="color: rgba(255,255,255,0.5);"></i>
      </div>
      
      <div class="menu-item" onclick="logout()" style="display: flex; align-items: center; padding: 15px;">
        <i class="fas fa-sign-out-alt" style="width: 30px; color: #f44336;"></i>
        <span style="color: #f44336; flex: 1;">Logout</span>
      </div>
    </div>

    <!-- Account Info -->
    <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px;">
      <h4 style="color: white; margin-bottom: 10px;">Account Information</h4>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span style="color: rgba(255,255,255,0.6);">Member Since</span>
        <span style="color: white;" id="memberSince">Loading...</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span style="color: rgba(255,255,255,0.6);">Referral Code</span>
        <span style="color: #4facfe; font-weight: bold;" id="referralCodeDisplay">CAD12345</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span style="color: rgba(255,255,255,0.6);">Account Status</span>
        <span style="color: #4caf50;" id="accountStatus">Active</span>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="nav-item" onclick="location.href='dashboard.html'">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </div>
      <div class="nav-item" onclick="location.href='products.html'">
        <i class="fas fa-box"></i>
        <span>Products</span>
      </div>
      <div class="nav-item" onclick="location.href='promotion.html'">
        <i class="fas fa-bullhorn"></i>
        <span>Promotion</span>
      </div>
      <div class="nav-item active" onclick="location.href='profile.html'">
        <i class="fas fa-user"></i>
        <span>Profile</span>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: #333;">Edit Profile</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      
      <form id="editProfileForm" onsubmit="event.preventDefault(); saveProfile();">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="editUsername" class="form-control" required>
        </div>
        
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="editPhone" class="form-control">
        </div>
        
        <div class="form-group">
          <label>Address</label>
          <textarea id="editAddress" class="form-control" rows="3"></textarea>
        </div>
        
        <button type="submit" class="btn">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    let currentUser = null;
    
    firebase.auth().onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        currentUser = user;
        loadProfile(user.uid);
      }
    });
    
    function loadProfile(userId) {
      const db = firebase.firestore();
      
      db.collection('users').doc(userId).get()
        .then((doc) => {
          if (doc.exists) {
            const userData = doc.data();
            
            document.getElementById('profileName').textContent = userData.username || 'User';
            document.getElementById('profileEmail').textContent = userData.email;
            document.getElementById('walletBalance').textContent = '₹' + (userData.wallet || 0);
            document.getElementById('totalInvestment').textContent = '₹' + (userData.totalInvestment || 0);
            document.getElementById('totalEarnings').textContent = '₹' + (userData.totalEarnings || 0);
            document.getElementById('referralCodeDisplay').textContent = userData.referralCode || 'CAD' + userId.slice(0,5);
            
            if (userData.createdAt) {
              const date = userData.createdAt.toDate();
              document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
            }
            
            if (userData.profileImage) {
              document.getElementById('profileImage').src = userData.profileImage;
            }
            
            // Set edit form values
            document.getElementById('editUsername').value = userData.username || '';
            document.getElementById('editPhone').value = userData.phone || '';
            document.getElementById('editAddress').value = userData.address || '';
          }
        });
    }
    
    function editProfile() {
      document.getElementById('editProfileModal').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('editProfileModal').classList.remove('active');
    }
    
    function saveProfile() {
      const db = firebase.firestore();
      
      db.collection('users').doc(currentUser.uid).update({
        username: document.getElementById('editUsername').value,
        phone: document.getElementById('editPhone').value,
        address: document.getElementById('editAddress').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert('Profile updated successfully!');
        closeModal();
        loadProfile(currentUser.uid);
      }).catch((error) => {
        alert('Error: ' + error.message);
      });
    }
    
    function changeProfileImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const storageRef = firebase.storage().ref();
        const imageRef = storageRef.child(`profileImages/${currentUser.uid}`);
        
        imageRef.put(file).then(() => {
          return imageRef.getDownloadURL();
        }).then((url) => {
          return firebase.firestore().collection('users').doc(currentUser.uid).update({
            profileImage: url
          });
        }).then(() => {
          document.getElementById('profileImage').src = URL.createObjectURL(file);
          alert('Profile image updated!');
        }).catch((error) => {
          alert('Error: ' + error.message);
        });
      };
      input.click();
    }
    
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      });
    }
  </script>
</body>
  </html>
