<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management - Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/admin.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar (same as users.html) -->
    <div class="admin-sidebar">
      <!-- ... sidebar content ... -->
    </div>

    <!-- Main Content -->
    <div class="admin-main">
      <div class="admin-header">
        <h1>Product Management</h1>
        <div class="header-actions">
          <button class="btn" onclick="showAddProductModal()">
            <i class="fas fa-plus"></i> Add Product
          </button>
        </div>
      </div>

      <!-- Products Table -->
      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Price</th>
              <th>Daily Profit</th>
              <th>Total Income</th>
              <th>Duration (Days)</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsTable">
            <tr>
              <td colspan="8" class="text-center">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Product Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Product</h2>
        <button class="close-btn" onclick="closeProductModal()">&times;</button>
      </div>
      
      <form id="productForm" onsubmit="event.preventDefault(); saveProduct();">
        <input type="hidden" id="productId">
        
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="productName" class="form-control" required>
        </div>
        
        <div class="form-group">
          <label>Product Image</label>
          <input type="file" id="productImage" accept="image/*" class="form-control">
          <img id="imagePreview" style="max-width: 100px; margin-top: 10px; display: none;">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Price (₹)</label>
            <input type="number" id="productPrice" class="form-control" step="0.01" required>
          </div>
          
          <div class="form-group">
            <label>Daily Profit (₹)</label>
            <input type="number" id="productDailyProfit" class="form-control" step="0.01" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Total Income (₹)</label>
            <input type="number" id="productTotalIncome" class="form-control" step="0.01" required>
          </div>
          
          <div class="form-group">
            <label>Duration (Days)</label>
            <input type="number" id="productDays" class="form-control" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>Status</label>
          <select id="productStatus" class="form-control">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        
        <button type="submit" class="btn">Save Product</button>
      </form>
    </div>
  </div>

  <script>
    firebase.auth().onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        loadProducts();
      }
    });

    function loadProducts() {
      const db = firebase.firestore();
      const tbody = document.getElementById('productsTable');
      
      db.collection('products').orderBy('createdAt', 'desc').get()
        .then((snapshot) => {
          tbody.innerHTML = '';
          
          snapshot.forEach((doc) => {
            const product = doc.data();
            tbody.innerHTML += `
              <tr>
                <td>
                  <img src="${product.image || 'https://via.placeholder.com/50'}" 
                       style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                </td>
                <td>${product.name}</td>
                <td>₹${product.price}</td>
                <td>₹${product.dailyProfit}</td>
                <td>₹${product.totalIncome}</td>
                <td>${product.days}</td>
                <td>
                  <span class="badge ${product.active ? 'success' : 'pending'}">
                    ${product.active ? 'Active' : 'Inactive'}
                  </span>
                </td>
                <td>
                  <button onclick="editProduct('${doc.id}')" class="btn-small">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="toggleProductStatus('${doc.id}', ${product.active})" class="btn-small">
                    <i class="fas ${product.active ? 'fa-eye-slash' : 'fa-eye'}"></i>
                  </button>
                  <button onclick="deleteProduct('${doc.id}')" class="btn-small">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
          });
        });
    }

    function showAddProductModal() {
      document.getElementById('modalTitle').textContent = 'Add Product';
      document.getElementById('productId').value = '';
      document.getElementById('productForm').reset();
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('productModal').classList.add('active');
    }

    async function editProduct(productId) {
      const db = firebase.firestore();
      const doc = await db.collection('products').doc(productId).get();
      
      if (doc.exists) {
        const product = doc.data();
        document.getElementById('modalTitle').textContent = 'Edit Product';
        document.getElementById('productId').value = productId;
        document.getElementById('productName').value = product.name;
        document.getElementById('productPrice').value = product.price;
        document.getElementById('productDailyProfit').value = product.dailyProfit;
        document.getElementById('productTotalIncome').value = product.totalIncome;
        document.getElementById('productDays').value = product.days;
        document.getElementById('productStatus').value = product.active;
        
        if (product.image) {
          document.getElementById('imagePreview').src = product.image;
          document.getElementById('imagePreview').style.display = 'block';
        }
        
        document.getElementById('productModal').classList.add('active');
      }
    }

    async function saveProduct() {
      const productId = document.getElementById('productId').value;
      const db = firebase.firestore();
      const imageFile = document.getElementById('productImage').files[0];
      
      let imageUrl = '';
      
      if (imageFile) {
        // Upload image to Firebase Storage
        const storageRef = firebase.storage().ref();
        const imageRef = storageRef.child(`products/${Date.now()}_${imageFile.name}`);
        await imageRef.put(imageFile);
        imageUrl = await imageRef.getDownloadURL();
      }
      
      const productData = {
        name: document.getElementById('productName').value,
        price: parseFloat(document.getElementById('productPrice').value),
        dailyProfit: parseFloat(document.getElementById('productDailyProfit').value),
        totalIncome: parseFloat(document.getElementById('productTotalIncome').value),
        days: parseInt(document.getElementById('productDays').value),
        active: document.getElementById('productStatus').value === 'true',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (imageUrl) {
        productData.image = imageUrl;
      }
      
      if (productId) {
        // Update existing product
        await db.collection('products').doc(productId).update(productData);
        alert('Product updated successfully!');
      } else {
        // Add new product
        productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('products').add(productData);
        alert('Product added successfully!');
      }
      
      closeProductModal();
      loadProducts();
    }

    async function toggleProductStatus(productId, currentStatus) {
      const db = firebase.firestore();
      await db.collection('products').doc(productId).update({
        active: !currentStatus
      });
      loadProducts();
    }

    async function deleteProduct(productId) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      
      const db = firebase.firestore();
      await db.collection('products').doc(productId).delete();
      loadProducts();
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('active');
    }
  </script>
</body>
  </html>
