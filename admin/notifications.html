<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notification Management - Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/admin.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="admin-logo">
        <i class="fas fa-crown"></i> Admin Panel
      </div>
      
      <div class="admin-menu">
        <a href="index.html" class="menu-item">
          <i class="fas fa-chart-pie"></i> Dashboard
        </a>
        <a href="users.html" class="menu-item">
          <i class="fas fa-users"></i> Users
        </a>
        <a href="products.html" class="menu-item">
          <i class="fas fa-box"></i> Products
        </a>
        <a href="investments.html" class="menu-item">
          <i class="fas fa-chart-line"></i> Investments
        </a>
        <a href="transactions.html" class="menu-item">
          <i class="fas fa-exchange-alt"></i> Transactions
        </a>
        <a href="referrals.html" class="menu-item">
          <i class="fas fa-sitemap"></i> Referrals
        </a>
        <a href="checkin.html" class="menu-item">
          <i class="fas fa-calendar-check"></i> Check-In
        </a>
        <a href="notifications.html" class="menu-item active">
          <i class="fas fa-bell"></i> Notifications
        </a>
        <a href="security.html" class="menu-item">
          <i class="fas fa-shield-alt"></i> Security
        </a>
        <a href="roles.html" class="menu-item">
          <i class="fas fa-user-tag"></i> Roles
        </a>
      </div>
      
      <div class="admin-footer">
        <div class="user-info">
          <i class="fas fa-user-circle"></i>
          <span id="adminName">Admin</span>
        </div>
        <button onclick="logout()" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="admin-main">
      <div class="admin-header">
        <h1>Notification Management</h1>
        <div class="header-actions">
          <button class="btn" onclick="showSendModal()">
            <i class="fas fa-paper-plane"></i> Send Notification
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
        <div style="background: linear-gradient(45deg, #4facfe, #00f2fe); padding: 15px; border-radius: 10px;">
          <div style="color: white; font-size: 12px;">Total Sent</div>
          <div style="color: white; font-size: 24px; font-weight: bold;" id="totalSent">0</div>
        </div>
        <div style="background: linear-gradient(45deg, #4caf50, #8bc34a); padding: 15px; border-radius: 10px;">
          <div style="color: white; font-size: 12px;">Delivered</div>
          <div style="color: white; font-size: 24px; font-weight: bold;" id="delivered">0</div>
        </div>
        <div style="background: linear-gradient(45deg, #ff9800, #f57c00); padding: 15px; border-radius: 10px;">
          <div style="color: white; font-size: 12px;">Opened</div>
          <div style="color: white; font-size: 24px; font-weight: bold;" id="opened">0</div>
        </div>
        <div style="background: linear-gradient(45deg, #9b59b6, #8e44ad); padding: 15px; border-radius: 10px;">
          <div style="color: white; font-size: 12px;">Click Rate</div>
          <div style="color: white; font-size: 24px; font-weight: bold;" id="clickRate">0%</div>
        </div>
      </div>

      <!-- Quick Templates -->
      <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
        <h3 style="color: #333; margin-bottom: 15px;">Quick Templates</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
          <button onclick="useTemplate('welcome')" class="btn-template" style="padding: 10px; background: #f0f0f0; border: none; border-radius: 5px;">
            <i class="fas fa-hand-peace"></i> Welcome
          </button>
          <button onclick="useTemplate('profit')" class="btn-template" style="padding: 10px; background: #f0f0f0; border: none; border-radius: 5px;">
            <i class="fas fa-coins"></i> Profit Update
          </button>
          <button onclick="useTemplate('promo')" class="btn-template" style="padding: 10px; background: #f0f0f0; border: none; border-radius: 5px;">
            <i class="fas fa-gift"></i> Promotion
          </button>
          <button onclick="useTemplate('maintenance')" class="btn-template" style="padding: 10px; background: #f0f0f0; border: none; border-radius: 5px;">
            <i class="fas fa-tools"></i> Maintenance
          </button>
        </div>
      </div>

      <!-- Notification History -->
      <div style="background: white; border-radius: 10px; padding: 20px;">
        <h3 style="color: #333; margin-bottom: 15px;">Notification History</h3>
        <div class="table-responsive">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Title</th>
                <th>Type</th>
                <th>Target</th>
                <th>Sent</th>
                <th>Opened</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="notificationsTable">
              <tr>
                <td colspan="8" class="text-center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Send Notification Modal -->
  <div id="sendModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Send Notification</h2>
        <button class="close-btn" onclick="closeSendModal()">&times;</button>
      </div>
      
      <form onsubmit="event.preventDefault(); sendNotification();">
        <div class="form-group">
          <label>Notification Type</label>
          <select id="notifType" class="form-control" onchange="toggleTargetFields()">
            <option value="all">All Users</option>
            <option value="specific">Specific Users</option>
            <option value="investors">Investors Only</option>
            <option value="active">Active Users</option>
          </select>
        </div>
        
        <div id="userSelectFields" style="display: none;">
          <div class="form-group">
            <label>Select Users</label>
            <select id="userMultiSelect" class="form-control" multiple size="5">
              <!-- Users will be loaded here -->
            </select>
            <small style="color: #666;">Hold Ctrl/Cmd to select multiple</small>
          </div>
        </div>
        
        <div class="form-group">
          <label>Notification Title</label>
          <input type="text" id="notifTitle" class="form-control" maxlength="100" required>
        </div>
        
        <div class="form-group">
          <label>Notification Message</label>
          <textarea id="notifMessage" class="form-control" rows="4" maxlength="500" required></textarea>
          <small id="charCount" style="color: #666;">0/500</small>
        </div>
        
        <div class="form-group">
          <label>Action Button (Optional)</label>
          <input type="text" id="notifButton" class="form-control" placeholder="Button text">
        </div>
        
        <div class="form-group">
          <label>Action Link (Optional)</label>
          <input type="url" id="notifLink" class="form-control" placeholder="https://">
        </div>
        
        <div class="form-group">
          <label>Priority</label>
          <select id="notifPriority" class="form-control">
            <option value="high">High (Red)</option>
            <option value="normal" selected>Normal (Blue)</option>
            <option value="low">Low (Gray)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Schedule</label>
          <select id="notifSchedule" class="form-control" onchange="toggleSchedule()">
            <option value="now">Send Now</option>
            <option value="later">Schedule Later</option>
          </select>
        </div>
        
        <div id="scheduleFields" style="display: none;">
          <div class="form-group">
            <label>Schedule Date & Time</label>
            <input type="datetime-local" id="scheduleTime" class="form-control">
          </div>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="saveTemplate"> Save as template
          </label>
        </div>
        
        <button type="submit" class="btn">Send Notification</button>
      </form>
    </div>
  </div>

  <script>
    firebase.auth().onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        checkAdminStatus(user.uid);
      }
    });
    
    function checkAdminStatus(userId) {
      firebase.firestore().collection('users').doc(userId).get()
        .then((doc) => {
          if (doc.exists && doc.data().role === 'admin') {
            document.getElementById('adminName').textContent = doc.data().username || 'Admin';
            loadNotifications();
            loadStats();
            loadUsers();
          } else {
            window.location.href = '../dashboard.html';
          }
        });
    }
    
    function loadStats() {
      const db = firebase.firestore();
      
      db.collection('notifications').get()
        .then((snapshot) => {
          let total = 0;
          let delivered = 0;
          let opened = 0;
          
          snapshot.forEach((doc) => {
            const notif = doc.data();
            total++;
            delivered += notif.deliveredCount || 0;
            opened += notif.openedCount || 0;
          });
          
          document.getElementById('totalSent').textContent = total;
          document.getElementById('delivered').textContent = delivered;
          document.getElementById('opened').textContent = opened;
          
          const clickRate = delivered > 0 ? ((opened / delivered) * 100).toFixed(1) : 0;
          document.getElementById('clickRate').textContent = clickRate + '%';
        });
    }
    
    function loadNotifications() {
      const db = firebase.firestore();
      const tbody = document.getElementById('notificationsTable');
      
      db.collection('notifications')
        .orderBy('createdAt', 'desc')
        .limit(50)
        .get()
        .then((snapshot) => {
          tbody.innerHTML = '';
          
          snapshot.forEach((doc) => {
            const notif = doc.data();
            const date = notif.createdAt ? new Date(notif.createdAt.toDate()).toLocaleString() : 'N/A';
            
            tbody.innerHTML += `
              <tr>
                <td>${date}</td>
                <td>${notif.title}</td>
                <td>${notif.type || 'all'}</td>
                <td>${notif.targetCount || 0} users</td>
                <td>${notif.deliveredCount || 0}</td>
                <td>${notif.openedCount || 0}</td>
                <td><span class="badge ${notif.status || 'completed'}">${notif.status || 'sent'}</span></td>
                <td>
                  <button onclick="viewNotification('${doc.id}')" class="btn-small">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button onclick="resendNotification('${doc.id}')" class="btn-small">
                    <i class="fas fa-redo"></i>
                  </button>
                </td>
              </tr>
            `;
          });
        });
    }
    
    function loadUsers() {
      const db = firebase.firestore();
      const select = document.getElementById('userMultiSelect');
      
      db.collection('users').limit(100).get()
        .then((snapshot) => {
          select.innerHTML = '';
          snapshot.forEach((doc) => {
            const user = doc.data();
            select.innerHTML += `<option value="${doc.id}">${user.username || user.email}</option>`;
          });
        });
    }
    
    function showSendModal() {
      document.getElementById('sendModal').classList.add('active');
    }
    
    function closeSendModal() {
      document.getElementById('sendModal').classList.remove('active');
    }
    
    function toggleTargetFields() {
      const type = document.getElementById('notifType').value;
      const userFields = document.getElementById('userSelectFields');
      
      userFields.style.display = type === 'specific' ? 'block' : 'none';
    }
    
    function toggleSchedule() {
      const schedule = document.getElementById('notifSchedule').value;
      const scheduleFields = document.getElementById('scheduleFields');
      
      scheduleFields.style.display = schedule === 'later' ? 'block' : 'none';
    }
    
    function useTemplate(template) {
      const title = document.getElementById('notifTitle');
      const message = document.getElementById('notifMessage');
      
      switch(template) {
        case 'welcome':
          title.value = 'Welcome to Cadbury Dairy Milk! ðŸŽ‰';
          message.value = 'Thank you for joining our investment platform. Start earning daily profits today!';
          break;
        case 'profit':
          title.value = 'Daily Profit Credited ðŸ’°';
          message.value = 'Your daily profit has been credited to your wallet. Keep investing for more returns!';
          break;
        case 'promo':
          title.value = 'Special Promotion! ðŸŽ';
          message.value = 'Get 10% bonus on your next investment. Limited time offer!';
          break;
        case 'maintenance':
          title.value = 'Scheduled Maintenance ðŸ”§';
          message.value = 'Platform will be under maintenance on Sunday from 2 AM to 4 AM.';
          break;
      }
    }
    
    function sendNotification() {
      const type = document.getElementById('notifType').value;
      const title = document.getElementById('notifTitle').value;
      const message = document.getElementById('notifMessage').value;
      const button = document.getElementById('notifButton').value;
      const link = document.getElementById('notifLink').value;
      const priority = document.getElementById('notifPriority').value;
      const schedule = document.getElementById('notifSchedule').value;
      const scheduleTime = document.getElementById('scheduleTime').value;
      const saveTemplate = document.getElementById('saveTemplate').checked;
      
      // Get target users
      let targetUsers = [];
      if (type === 'specific') {
        const select = document.getElementById('userMultiSelect');
        targetUsers = Array.from(select.selectedOptions).map(opt => opt.value);
      }
      
      const notification = {
        type: type,
        title: title,
        message: message,
        button: button || null,
        link: link || null,
        priority: priority,
        status: schedule === 'later' ? 'scheduled' : 'sending',
        targetUsers: targetUsers,
        deliveredCount: 0,
        openedCount: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: firebase.auth().currentUser.uid
      };
      
      if (schedule === 'later' && scheduleTime) {
        notification.scheduledFor = new Date(scheduleTime);
      }
      
      const db = firebase.firestore();
      db.collection('notifications').add(notification)
        .then((docRef) => {
          if (schedule === 'now') {
            // Send immediately
            return sendToUsers(docRef.id, notification);
          }
          return Promise.resolve();
        })
        .then(() => {
          if (saveTemplate) {
            // Save as template
            return db.collection('notificationTemplates').add({
              title: title,
              message: message,
              button: button,
              link: link,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        })
        .then(() => {
          alert('Notification ' + (schedule === 'later' ? 'scheduled' : 'sent') + ' successfully!');
          closeSendModal();
          loadNotifications();
          loadStats();
        })
        .catch((error) => {
          alert('Error: ' + error.message);
        });
    }
    
    function sendToUsers(notifId, notification) {
      const db = firebase.firestore();
      let userQuery;
      
      if (notification.type === 'specific') {
        // Send to specific users
        const promises = notification.targetUsers.map(userId => {
          return db.collection('userNotifications').add({
            userId: userId,
            notificationId: notifId,
            title: notification.title,
            message: notification.message,
            button: notification.button,
            link: notification.link,
            priority: notification.priority,
            read: false,
            delivered: true,
            deliveredAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        
        return Promise.all(promises).then(() => {
          // Update delivered count
          return db.collection('notifications').doc(notifId).update({
            deliveredCount: notification.targetUsers.length,
            status: 'sent'
          });
        });
      } else {
        // Send to all users
        return db.collection('users').get()
          .then((snapshot) => {
            const batch = db.batch();
            let count = 0;
            
            snapshot.forEach((userDoc) => {
              const notifRef = db.collection('userNotifications').doc();
              batch.set(notifRef, {
                userId: userDoc.id,
                notificationId: notifId,
                title: notification.title,
                message: notification.message,
                button: notification.button,
                link: notification.link,
                priority: notification.priority,
                read: false,
                delivered: true,
                deliveredAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              count++;
            });
            
            return batch.commit().then(() => count);
          })
          .then((count) => {
            // Update delivered count
            return db.collection('notifications').doc(notifId).update({
              deliveredCount: count,
              status: 'sent'
            });
          });
      }
    }
    
    function viewNotification(id) {
      // Open notification details
      alert('View notification details: ' + id);
    }
    
    function resendNotification(id) {
      if (!confirm('Resend this notification?')) return;
      
      const db = firebase.firestore();
      db.collection('notifications').doc(id).get()
        .then((doc) => {
          if (!doc.exists) throw new Error('Notification not found');
          
          const notif = doc.data();
          return sendToUsers(id, notif);
        })
        .then(() => {
          alert('Notification resent!');
          loadNotifications();
        })
        .catch((error) => {
          alert('Error: ' + error.message);
        });
    }
    
    // C
